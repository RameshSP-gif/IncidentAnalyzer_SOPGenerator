<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Incident Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f7fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        h1 { margin-bottom: 30px; color: #2d3748; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; color: white; }
        .stat-card:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-value { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-label { font-size: 0.95em; opacity: 0.9; }
        
        .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-info { background: #4299e1; color: white; }
        
        .filters { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
        .filters input, .filters select { padding: 10px 15px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .filters input { flex: 1; min-width: 250px; }
        
        table { width: 100%; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        thead { background: #4a5568; color: white; }
        th, td { padding: 15px; text-align: left; }
        tbody tr:hover { background: #f7fafc; }
        tbody tr { border-bottom: 1px solid #e2e8f0; }
        
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 500; }
        .badge-1 { background: #fed7d7; color: #c53030; }
        .badge-2 { background: #feebc8; color: #c05621; }
        .badge-3 { background: #fefcbf; color: #975a16; }
        .badge-4 { background: #c6f6d5; color: #22543d; }
        
        .action-btns { display: flex; gap: 5px; }
        .action-btns button { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .action-btns button:hover { opacity: 0.8; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; max-width: 600px; margin: 50px auto; padding: 30px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 20px; color: #2d3748; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        
        .pagination { display: flex; gap: 5px; justify-content: center; margin-top: 25px; }
        .pagination button { padding: 8px 12px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4; }
        .alert-error { background: #fed7d7; color: #c53030; border: 1px solid #fc8181; }
        
        #loading { text-align: center; padding: 40px; color: #718096; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>üìä MongoDB Incident Manager</h1>
            <button class="btn btn-info" onclick="window.location.href='/'">‚¨ÖÔ∏è Back to Analyzer</button>
        </div>
        
        <div id="alert-container"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total Incidents</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Categories</div>
                <div class="stat-value" id="stat-categories">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Recent (Today)</div>
                <div class="stat-value" id="stat-recent">0</div>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="showAddModal()">‚ûï Add Incident</button>
            <button class="btn btn-success" onclick="showImportModal()">üìÅ Import CSV</button>
            <button class="btn btn-info" onclick="exportCSV()">üíæ Export CSV</button>
            <button class="btn btn-info" onclick="window.location.reload()">üîÑ Refresh</button>
            <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All</button>
        </div>
        
        <div class="filters">
            <input type="text" id="search-query" placeholder="üîç Search incidents..." onkeyup="applyFilters()">
            <select id="search-category" onchange="applyFilters()">
                <option value="">All Categories</option>
            </select>
            <select id="search-priority" onchange="applyFilters()">
                <option value="">All Priorities</option>
                <option value="1">Priority 1</option>
                <option value="2">Priority 2</option>
                <option value="3">Priority 3</option>
                <option value="4">Priority 4</option>
            </select>
        </div>
        
        <div id="loading">Loading incidents...</div>
        
        <table id="incidents-table" style="display: none;">
            <thead>
                <tr>
                    <th>Number</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Priority</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="incidents-tbody"></tbody>
        </table>
        
        <div id="pagination" class="pagination"></div>
    </div>
    
    <!-- Add/Edit Modal -->
    <div id="incident-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Add Incident</h2>
            <form id="incident-form">
                <div class="form-group">
                    <label>Incident Number *</label>
                    <input type="text" id="form-number" required>
                </div>
                <div class="form-group">
                    <label>Short Description *</label>
                    <input type="text" id="form-short-desc" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="form-description"></textarea>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="form-category">
                        <option>Email</option>
                        <option>Network</option>
                        <option>Hardware</option>
                        <option>Software</option>
                        <option>Database</option>
                        <option>Access</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select id="form-priority">
                        <option value="1">1 - Critical</option>
                        <option value="2">2 - High</option>
                        <option value="3" selected>3 - Medium</option>
                        <option value="4">4 - Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subcategory</label>
                    <input type="text" id="form-subcategory">
                </div>
                <div class="form-group">
                    <label>State</label>
                    <select id="form-state">
                        <option value="New">New</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Resolution Notes</label>
                    <textarea id="form-resolution"></textarea>
                </div>
                <div class="form-group">
                    <label>Close Notes</label>
                    <textarea id="form-close-notes"></textarea>
                </div>
                <div class="form-group">
                    <label>Assignment Group</label>
                    <input type="text" id="form-assignment-group">
                </div>
                <div class="form-group">
                    <label>Assigned To</label>
                    <input type="text" id="form-assigned-to">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal()" style="background: #cbd5e0;">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- View Modal -->
    <div id="view-modal" class="modal">
        <div class="modal-content">
            <h2>View Incident</h2>
            <div id="view-content" style="line-height: 1.8;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-info" onclick="closeViewModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <h2>Import CSV File</h2>
            <input type="file" id="csv-file" accept=".csv">
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeImportModal()" style="background: #cbd5e0;">Cancel</button>
                <button class="btn btn-success" onclick="uploadCSV()">Import</button>
            </div>
            <div id="import-status" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <script>
        let currentPage = 1;
        const perPage = 20;
        let allIncidents = [];
        let filteredIncidents = [];
        let editingNumber = null;
        
        // Load data on page load
        window.onload = function() {
            loadStats();
            loadIncidents();
        };
        
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function loadStats() {
            fetch('/get_stats')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('stat-total').textContent = data.total_incidents;
                        document.getElementById('stat-categories').textContent = data.category_count;
                        document.getElementById('stat-recent').textContent = data.recent_incidents.length;
                        
                        const catSelect = document.getElementById('search-category');
                        catSelect.innerHTML = '<option value="">All Categories</option>';
                        data.categories.forEach(cat => {
                            catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                        });
                    }
                })
                .catch(err => showAlert('Failed to load stats', 'error'));
        }
        
        function loadIncidents() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('incidents-table').style.display = 'none';
            
            fetch('/get_incidents?limit=1000')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        allIncidents = data.incidents;
                        filteredIncidents = allIncidents;
                        renderIncidents();
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('incidents-table').style.display = 'table';
                    } else {
                        showAlert('Failed to load incidents', 'error');
                    }
                })
                .catch(err => {
                    showAlert('Error loading incidents: ' + err.message, 'error');
                    document.getElementById('loading').style.display = 'none';
                });
        }
        
        function renderIncidents() {
            const tbody = document.getElementById('incidents-tbody');
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pageIncidents = filteredIncidents.slice(start, end);
            
            if (pageIncidents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">No incidents found</td></tr>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            tbody.innerHTML = pageIncidents.map(inc => `
                <tr>
                    <td><strong>${inc.number}</strong></td>
                    <td>${inc.short_description || 'N/A'}</td>
                    <td><span class="badge">${inc.category || 'General'}</span></td>
                    <td><span class="badge badge-${inc.priority}">${inc.priority || '3'}</span></td>
                    <td>${inc.sys_created_on ? new Date(inc.sys_created_on).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <div class="action-btns">
                            <button onclick="viewIncident('${inc.number}')" style="background: #4299e1; color: white;">üëÅÔ∏è View</button>
                            <button onclick="editIncident('${inc.number}')" style="background: #48bb78; color: white;">‚úèÔ∏è Edit</button>
                            <button onclick="deleteIncident('${inc.number}')" style="background: #f56565; color: white;">üóëÔ∏è Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            renderPagination();
        }
        
        function renderPagination() {
            const totalPages = Math.ceil(filteredIncidents.length / perPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = `<button ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Previous</button>`;
            
            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            if (totalPages > 10) html += `<button onclick="goToPage(${totalPages})">...${totalPages}</button>`;
            html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>`;
            
            pagination.innerHTML = html;
        }
        
        function goToPage(page) {
            currentPage = page;
            renderIncidents();
        }
        
        function applyFilters() {
            const query = document.getElementById('search-query').value.toLowerCase();
            const category = document.getElementById('search-category').value;
            const priority = document.getElementById('search-priority').value;
            
            filteredIncidents = allIncidents.filter(inc => {
                const matchQuery = !query || 
                    (inc.number && inc.number.toLowerCase().includes(query)) ||
                    (inc.short_description && inc.short_description.toLowerCase().includes(query)) ||
                    (inc.description && inc.description.toLowerCase().includes(query));
                    
                const matchCategory = !category || inc.category === category;
                const matchPriority = !priority || inc.priority == priority;
                
                return matchQuery && matchCategory && matchPriority;
            });
            
            currentPage = 1;
            renderIncidents();
        }
        
        function viewIncident(number) {
            const incident = allIncidents.find(inc => inc.number === number);
            if (!incident) return;
            
            const content = `
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 15px;">
                    <strong>Incident Number:</strong><span>${incident.number || 'N/A'}</span>
                    <strong>Short Description:</strong><span>${incident.short_description || 'N/A'}</span>
                    <strong>Description:</strong><span>${incident.description || 'N/A'}</span>
                    <strong>Category:</strong><span>${incident.category || 'N/A'}</span>
                    <strong>Subcategory:</strong><span>${incident.subcategory || 'N/A'}</span>
                    <strong>Priority:</strong><span>${incident.priority || 'N/A'}</span>
                    <strong>State:</strong><span>${incident.state || 'N/A'}</span>
                    <strong>Resolution Notes:</strong><span>${incident.resolution_notes || 'N/A'}</span>
                    <strong>Close Notes:</strong><span>${incident.close_notes || 'N/A'}</span>
                    <strong>Assignment Group:</strong><span>${incident.assignment_group || 'N/A'}</span>
                    <strong>Assigned To:</strong><span>${incident.assigned_to || 'N/A'}</span>
                    <strong>Created:</strong><span>${incident.sys_created_on ? new Date(incident.sys_created_on).toLocaleString() : 'N/A'}</span>
                    <strong>Updated:</strong><span>${incident.sys_updated_on ? new Date(incident.sys_updated_on).toLocaleString() : 'N/A'}</span>
                    <strong>Resolved:</strong><span>${incident.resolved_at ? new Date(incident.resolved_at).toLocaleString() : 'N/A'}</span>
                </div>
            `;
            
            document.getElementById('view-content').innerHTML = content;
            document.getElementById('view-modal').style.display = 'block';
        }
        
        function closeViewModal() {
            document.getElementById('view-modal').style.display = 'none';
        }
        
        function showAddModal() {
            editingNumber = null;
            document.getElementById('modal-title').textContent = 'Add Incident';
            document.getElementById('incident-form').reset();
            document.getElementById('form-number').disabled = false;
            document.getElementById('incident-modal').style.display = 'block';
        }
        
        function editIncident(number) {
            editingNumber = number;
            const incident = allIncidents.find(inc => inc.number === number);
            if (!incident) return;
            
            document.getElementById('modal-title').textContent = 'Edit Incident';
            document.getElementById('form-number').value = incident.number;
            document.getElementById('form-number').disabled = true;
            document.getElementById('form-short-desc').value = incident.short_description || '';
            document.getElementById('form-description').value = incident.description || '';
            document.getElementById('form-category').value = incident.category || 'Email';
            document.getElementById('form-subcategory').value = incident.subcategory || '';
            document.getElementById('form-priority').value = incident.priority || '3';
            document.getElementById('form-state').value = incident.state || 'Closed';
            document.getElementById('form-resolution').value = incident.resolution_notes || '';
            document.getElementById('form-close-notes').value = incident.close_notes || '';
            document.getElementById('form-assignment-group').value = incident.assignment_group || '';
            document.getElementById('form-assigned-to').value = incident.assigned_to || '';
            document.getElementById('incident-modal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('incident-modal').style.display = 'none';
        }
        
        function showImportModal() {
            document.getElementById('import-modal').style.display = 'block';
        }
        
        function closeImportModal() {
            document.getElementById('import-modal').style.display = 'none';
        }
        
        document.getElementById('incident-form').onsubmit = function(e) {
            e.preventDefault();
            
            const data = {
                number: document.getElementById('form-number').value,
                short_description: document.getElementById('form-short-desc').value,
                description: document.getElementById('form-description').value,
                category: document.getElementById('form-category').value,
                subcategory: document.getElementById('form-subcategory').value,
                priority: document.getElementById('form-priority').value,
                state: document.getElementById('form-state').value,
                resolution_notes: document.getElementById('form-resolution').value,
                close_notes: document.getElementById('form-close-notes').value,
                assignment_group: document.getElementById('form-assignment-group').value,
                assigned_to: document.getElementById('form-assigned-to').value
            };
            
            const url = editingNumber ? `/update_incident/${editingNumber}` : '/add_incident';
            const method = editingNumber ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showAlert(editingNumber ? 'Incident updated!' : 'Incident added!');
                    closeModal();
                    loadStats();
                    loadIncidents();
                } else {
                    showAlert(result.error || 'Operation failed', 'error');
                }
            })
            .catch(err => showAlert('Error: ' + err.message, 'error'));
        };
        
        function deleteIncident(number) {
            if (!confirm(`Delete incident ${number}?`)) return;
            
            fetch(`/delete_incident/${number}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        showAlert('Incident deleted!');
                        loadStats();
                        loadIncidents();
                    } else {
                        showAlert(result.error || 'Delete failed', 'error');
                    }
                })
                .catch(err => showAlert('Error: ' + err.message, 'error'));
        }
        
        function uploadCSV() {
            const fileInput = document.getElementById('csv-file');
            if (!fileInput.files.length) {
                showAlert('Please select a CSV file', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            document.getElementById('import-status').innerHTML = '<p>Importing...</p>';
            
            fetch('/import_csv', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('import-status').innerHTML = `
                        <div class="alert alert-success">
                            Imported: ${result.imported}<br>
                            Skipped: ${result.skipped}<br>
                            Errors: ${result.errors}
                        </div>
                    `;
                    loadStats();
                    loadIncidents();
                    setTimeout(() => closeImportModal(), 3000);
                } else {
                    document.getElementById('import-status').innerHTML = `<div class="alert alert-error">${result.error}</div>`;
                }
            })
            .catch(err => {
                document.getElementById('import-status').innerHTML = `<div class="alert alert-error">Error: ${err.message}</div>`;
            });
        }
        
        function exportCSV() {
            window.location.href = '/export_csv';
        }
        
        function clearAllData() {
            if (!confirm('Are you sure you want to delete ALL incidents? This cannot be undone!')) return;
            
            fetch('/clear_all_incidents', { method: 'POST' })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        showAlert('All incidents cleared!');
                        loadStats();
                        loadIncidents();
                    } else {
                        showAlert(result.error || 'Clear failed', 'error');
                    }
                })
                .catch(err => showAlert('Error: ' + err.message, 'error'));
        }
    </script>
</body>
</html>
